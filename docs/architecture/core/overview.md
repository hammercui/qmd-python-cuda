# QMD 架构总览

**版本**: 1.0.0
**状态**: 设计完成
**最后更新**: 2026-02-18

---

## 架构概述

QMD-Python 采用 **Client-Server 分离架构**，优化显存占用和性能：

```
┌─────────────────────────────────────────────────────────────┐
│                        CLI 层                               │
│  ├─ 智能路由：自动选择执行方式                              │
│  ├─ 不需要模型 → 直接执行（零等待）                         │
│  └─ 需要模型 → HTTP Client（自动检测Server）                 │
└───────────────────────────┬─────────────────────────────────┘
                            │ HTTP
┌───────────────────────────▼─────────────────────────────────┐
│                    QMD Server（单一进程）                    │
│  ├─ 单例模型（4GB VRAM）                                    │
│  ├─ 队列串行（防止溢出）                                    │
│  ├─ 自动服务发现（端口检测 + 进程检测）                     │
│  └─ 多种 Transport（对外接口）                              │
│     ├─ HTTP Transport (port 18765)                          │
│     └─ MCP Transport (stdio)                                │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心组件

### 1. CLI 层（智能路由）

| 组件 | 职责 |
|------|------|
| **命令解析** | Click CLI框架 |
| **路由决策** | 根据命令类型选择执行方式 |
| **HTTP客户端** | 与Server通信 |
| **数据库操作** | 直接访问SQLite（不需要模型时） |

### 2. Server 层（单一进程）

| 组件 | 职责 |
|------|------|
| **搜索引擎** | BM25 + 向量搜索 + 混合搜索 |
| **模型引擎** | Embedding + Reranker + LLM |
| **队列管理** | 串行化执行（防止显存溢出） |
| **自动服务发现** | 端口检测 + 进程检测 + 自动启动 |
| **Transport层** | HTTP + MCP |

---

## 工作流程

### 场景1：BM25搜索（不需要模型）

```bash
qmd search "query"
```

```
CLI → 直接访问 SQLite → 返回结果（零等待）
```

**性能**：
- 延迟：~750ms
- 显存：0GB
- Server：不需要

---

### 场景2：向量搜索（需要模型）

```bash
qmd vsearch "query"
```

```
CLI → 检测Server（18765） → HTTP API → 返回结果
     ↓
  未运行？ → 自动启动Server → 连接
```

**性能**：
- 延迟：15-30ms
- 显存：4GB（共享）
- Server：自动管理

---

### 场景3：混合搜索（需要模型）

```bash
qmd query "query"
```

```
CLI → 检测Server → HTTP API
                         ↓
                    Query扩展 → Embed → 向量搜索 → 重排序 → 返回
```

**性能**：
- 延迟：~75ms
- 显存：4GB（共享）
- Server：自动管理

---

## HTTP 端点规范

| 端点 | 方法 | 功能 | 是否需要模型 |
|------|------|------|-------------|
| `/embed` | POST | 生成嵌入向量 | ✅ |
| `/vsearch` | POST | 向量搜索 | ✅ |
| `/query` | POST | 混合搜索 | ✅ |
| `/health` | GET | 健康检查 | ❌ |

**默认端口**：18765（IANA非标准端口，冲突概率极低）

---

## 显存占用对比

| 场景 | 并行模式（假设） | Client-Server |
|------|----------------|---------------|
| 1个查询 | 4GB | 4GB |
| 10个并发 | 40GB ❌ | 4GB ✅ |
| 100个并发 | 400GB ❌ | 4GB ✅ |

**显存节省**：90%！

---

## 架构优势

| 维度 | 分离设计 | 统一架构 |
|------|----------|----------|
| **进程数** | 2 个 | 1 个 |
| **显存占用** | 8GB（两个模型） | 4GB（单例） |
| **代码复用** | 低（重复逻辑） | 高（共享核心） |
| **维护成本** | 高（两套代码） | 低（单一代码库） |
| **用户体验** | 困惑（两个命令） | 简单（一个命令） |

---

## 配置文件

### YAML 配置

```yaml
# ~/.config/qmd/server.yml
server:
  # Transport 模式：http | mcp | both
  transport: both

  # HTTP 配置
  http:
    host: 127.0.0.1
    port: 18765
    log_level: info

  # MCP 配置
  mcp:
    enabled: true

  # 自动服务发现
  auto_discovery:
    enabled: true
    port_file: ~/.qmd/server_port.txt
    max_attempts: 100

  # 队列配置
  queue:
    max_concurrent: 1  # 串行执行
    timeout: 30        # 超时时间（秒）
```

---

## 相关文档

- [Client-Server分离决策](../decisions/2026-02-15-client-server-separation.md) - 决策记录
- [Transport设计](../core/transport-design.md) - Transport层设计
- [自动服务发现](../auto-discovery/overview.md) - 零配置服务发现机制

---

**文档版本**: 1.0.0
**最后更新**: 2026-02-18
