# QMD MCP Server é¡¹ç›® - éœ€æ±‚æ€»ç»“ä¸è¿›åº¦

**æ—¥æœŸ**: 2026-02-14
**è´Ÿè´£äºº**: Zandar (CTO+COO)
**é¡¹ç›®è·¯å¾„**: `D:\moneyProject\qmd-python-new`

---

## ğŸ“‹ éœ€æ±‚æ€»ç»“

### æ ¸å¿ƒé—®é¢˜

**å½“å‰æ¶æ„é—®é¢˜**ï¼š
- qmd ä»¥ CLI å‘½ä»¤å½¢å¼å¯åŠ¨
- æ¯æ¬¡æ‰§è¡Œåˆ›å»ºæ–°è¿›ç¨‹
- æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹åŠ è½½ embed æ¨¡å‹ï¼ˆbge-small-en-v1.5ï¼‰
- **å¤šè¿›ç¨‹å¹¶å‘æ—¶æ˜¾å­˜æš´å¢**

**æ˜¾å­˜å ç”¨åœºæ™¯**ï¼š
```
3 ä¸ªå¹¶å‘ qmd è¿›ç¨‹ï¼š
- è¿›ç¨‹ 1: 2-4GB VRAM
- è¿›ç¨‹ 2: 2-4GB VRAM
- è¿›ç¨‹ 3: 2-4GB VRAM
æ€»è®¡: 6-12GB VRAM (3 ä¸ªç‹¬ç«‹æ¨¡å‹å®ä¾‹)
```

### è§£å†³æ–¹æ¡ˆéœ€æ±‚

**MCP Server æ¶æ„**ï¼š

**æ ¸å¿ƒè®¾è®¡**ï¼š
- **Server æ¨¡å¼**ï¼šå•ä¸ªå¸¸é©»è¿›ç¨‹ï¼ŒåŠ è½½ä¸€æ¬¡æ¨¡å‹ï¼ˆ2-4GBï¼‰
- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šæ‰€æœ‰ embed è¯·æ±‚é€šè¿‡é˜Ÿåˆ—ä¸²è¡Œå¤„ç†
- **ç½‘ç»œåè®®**ï¼šHTTP APIï¼ˆFastAPIï¼‰+ IPC
- **æ™ºèƒ½åˆ‡æ¢**ï¼šæ ¹æ®æ˜¾å­˜å¤§å°è‡ªåŠ¨é€‰æ‹©æ¨¡å¼
  - æ˜¾å­˜ â‰¥ 8GBï¼šç‹¬ç«‹è¿›ç¨‹æ¨¡å¼ï¼ˆå½“å‰ï¼‰
  - æ˜¾å­˜ < 8GBï¼šServer + é˜Ÿåˆ—æ¨¡å¼

**å…³é”®çº¦æŸ**ï¼š
- âœ… **å‘åå…¼å®¹**ï¼šä¿ç•™ç°æœ‰çš„æœ¬åœ°æ¨¡å¼ï¼ŒServer ä½œä¸ºå¯é€‰åŠŸèƒ½
- âœ… **æ˜¾å­˜æ£€æµ‹**ï¼šè‡ªåŠ¨é€‰æ‹©æ¨¡å¼ï¼ˆåŸºäº `torch.cuda.mem_get_info()`ï¼‰
- âœ… **é”™è¯¯å¤„ç†**ï¼šServer æŒ‚äº†ï¼Œè‡ªåŠ¨å›é€€åˆ° Standalone
- âœ… **æ€§èƒ½è¦æ±‚**ï¼šembed å»¶è¿Ÿ < 100msï¼ˆå³ä½¿ç»è¿‡é˜Ÿåˆ—ï¼‰

**ä¸è¦æ”¹çš„ä¸šåŠ¡é€»è¾‘**ï¼š
- âŒ CLI å‘½ä»¤æ¥å£ä¿æŒä¸å˜
- âŒ æ•°æ®åº“ schema ä¸å˜
- âŒ æœç´¢ç®—æ³•ï¼ˆBM25/Vector/Hybridï¼‰ä¸å˜
- âŒ Collection ç®¡ç†ä¸å˜

---

## âœ… å·²å®Œæˆå†…å®¹

### é˜¶æ®µ 1ï¼šServer æ ¸å¿ƒæ¨¡å— âœ…

#### 1.1 Server æ¨¡å—ç»“æ„
```
qmd/server/
â”œâ”€â”€ __init__.py      # æ¨¡å—å¯¼å‡º âœ…
â”œâ”€â”€ app.py          # FastAPI åº”ç”¨ âœ…
â”œâ”€â”€ client.py        # HTTP å®¢æˆ·ç«¯ âœ…
â””â”€â”€ models.py       # Pydantic æ¨¡å‹ âœ…
```

#### 1.2 FastAPI åº”ç”¨ (`qmd/server/app.py`)

**å·²å®ç°åŠŸèƒ½**ï¼š
- âœ… FastAPI åº”ç”¨ç»“æ„
- âœ… å•ä¾‹æ¨¡å‹åŠ è½½ï¼ˆstartup äº‹ä»¶ï¼‰
- âœ… å¼‚æ­¥é˜Ÿåˆ—å¤„ç†ï¼ˆasyncio.Queueï¼‰
- âœ… `/embed` POST ç«¯ç‚¹ï¼ˆç”Ÿæˆ embeddingsï¼‰
- âœ… `/health` GET ç«¯ç‚¹ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
- âœ… é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼ˆMAX_QUEUE_SIZE=100ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
- âœ… è¾“å…¥éªŒè¯ï¼ˆç©ºåˆ—è¡¨ã€è¶…å¤š textsï¼‰
- âœ… é”™è¯¯åˆ†ç±»å¤„ç†ï¼ˆValueError â†’ 400, RuntimeError â†’ 500ï¼‰

**ä»£ç è´¨é‡**ï¼š
- âœ… ç±»å‹æ³¨è§£å®Œå–„
- âœ… æ—¥å¿—è®°å½•ï¼ˆlogger.info/errorï¼‰
- âœ… å¼‚æ­¥å¤„ç†ï¼ˆasync/awaitï¼‰
- âœ… Pydantic æ•°æ®éªŒè¯

#### 1.3 HTTP å®¢æˆ·ç«¯ (`qmd/server/client.py`)

**å·²å®ç°åŠŸèƒ½**ï¼š
- âœ… EmbedServerClient ç±»
- âœ… HTTP å®¢æˆ·ç«¯ï¼ˆhttpxï¼‰
- âœ… è¶…æ—¶æ§åˆ¶ï¼ˆ5 ç§’ï¼‰
- âœ… å¥åº·æ£€æŸ¥æ–¹æ³•ï¼ˆhealth_checkï¼‰
- âœ… embed_texts æ–¹æ³•ï¼ˆPOST /embedï¼‰
- âœ… è‡ªåŠ¨é™çº§ï¼ˆserver ä¸å¯ç”¨è¿”å› Noneï¼‰
- âœ… èµ„æºæ¸…ç†ï¼ˆclose æ–¹æ³•ï¼‰

**ä»£ç è´¨é‡**ï¼š
- âœ… ç±»å‹æ³¨è§£å®Œå–„
- âœ… å¼‚å¸¸å¤„ç†ï¼ˆConnectError, TimeoutExceptionï¼‰
- âœ… å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆ_get_clientï¼‰

#### 1.4 æ•°æ®æ¨¡å‹ (`qmd/server/models.py`)

**å·²å®ç°åŠŸèƒ½**ï¼š
- âœ… EmbedRequestï¼ˆPydanticï¼‰
- âœ… EmbedResponseï¼ˆPydanticï¼‰
- âœ… HealthResponseï¼ˆPydanticï¼‰
- âœ… ç±»å‹æ³¨è§£å®Œæ•´

---

### é˜¶æ®µ 2ï¼šLLMEngine åŒæ¨¡å¼æ”¯æŒ âœ…

#### 2.1 å¼•æ“ä¿®æ”¹ (`qmd/llm/engine.py`)

**å·²å®ç°åŠŸèƒ½**ï¼š
- âœ… åŒæ¨¡å¼åˆå§‹åŒ–ï¼ˆstandalone / server / autoï¼‰
- âœ… VRAM è‡ªåŠ¨æ£€æµ‹ï¼ˆtorch.cuda.mem_get_infoï¼‰
- âœ… æ¨¡å¼é€‰æ‹©é€»è¾‘ï¼š
  - VRAM < 8GB â†’ server æ¨¡å¼
  - VRAM â‰¥ 8GB â†’ standalone æ¨¡å¼
  - æ—  CUDA â†’ standalone æ¨¡å¼
- âœ… MCP Server å®¢æˆ·ç«¯é›†æˆï¼ˆEmbedServerClientï¼‰
- âœ… è‡ªåŠ¨é™çº§ï¼ˆserver æŒ‚äº†å›é€€åˆ° standaloneï¼‰
- âœ… embed_texts æ–¹æ³•ï¼ˆæ ¹æ®æ¨¡å¼è·¯ç”±ï¼‰
- âœ… èµ„æºæ¸…ç†ï¼ˆclose æ–¹æ³•ï¼‰

**ä»£ç è´¨é‡æ”¹è¿›**ï¼š
- âœ… ç±»å‹æ³¨è§£å®Œå–„ï¼ˆTextEmbedding, EmbedServerClientï¼‰
- âœ… æ—¥å¿—è®°å½•ï¼ˆmode æ£€æµ‹ç»“æœã€é™çº§è­¦å‘Šï¼‰
- âœ… é”™è¯¯å¤„ç†ï¼ˆVRAM æ£€æµ‹å¤±è´¥æ—¶ fallbackï¼‰

---

### é˜¶æ®µ 3ï¼šCLI é›†æˆ âœ…

#### 3.1 Server å¯åŠ¨å‘½ä»¤ (`qmd/cli.py`)

**å·²å®ç°åŠŸèƒ½**ï¼š
- âœ… `qmd server` å‘½ä»¤
- âœ… `--host` é€‰é¡¹ï¼ˆé»˜è®¤ 127.0.0.1ï¼‰
- âœ… `--port` é€‰é¡¹ï¼ˆé»˜è®¤ 8000ï¼‰
- âœ… `--log-level` é€‰é¡¹ï¼ˆé»˜è®¤ infoï¼‰
- âœ… uvicorn é›†æˆ
- âœ… å‹å¥½è¾“å‡ºï¼ˆhost, port, model infoï¼‰
- âœ… ä¼˜é›…å…³é—­ï¼ˆsignal handler: SIGINT, SIGTERMï¼‰
- âœ… æ§åˆ¶å°æç¤ºï¼ˆæŒ‰ Ctrl+C åœæ­¢ï¼‰

**ä»£ç è´¨é‡æ”¹è¿›**ï¼š
- âœ… ä¿¡å·å¤„ç†ï¼ˆå‹å¥½å…³é—­ï¼‰
- âœ… ä¿¡æ¯è¾“å‡ºï¼ˆMax queue size æç¤ºï¼‰

---

### é˜¶æ®µ 4ï¼šé…ç½®ä¸ä¾èµ– âœ…

#### 4.1 pyproject.toml

**å·²å®ç°**ï¼š
- âœ… `[project.optional-dependencies.server]` ç»„
- âœ… ä¾èµ–ï¼šfastapi>=0.100.0, uvicorn[standard]>=0.23.0, httpx>=0.24.0

#### 4.2 æ–‡æ¡£ (`docs/MCP_SERVER.md`)

**å·²å®ç°**ï¼š
- âœ… æ¶æ„å›¾ï¼ˆASCII å›¾ç¤ºï¼‰
- âœ… å®‰è£…è¯´æ˜
- âœ… ä½¿ç”¨æŒ‡å—ï¼ˆServer æ¨¡å¼ / Standalone æ¨¡å¼ï¼‰
- âœ… æ¨¡å¼æ£€æµ‹é€»è¾‘
- âœ… API ç«¯ç‚¹æ–‡æ¡£
- âœ… Fallback è¡Œä¸ºè¯´æ˜
- âœ… æ€§èƒ½å¯¹æ¯”è¡¨
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—
- âœ… å¼€å‘è€…æŒ‡å—

---

### é˜¶æ®µ 5ï¼šæµ‹è¯• âœ…

#### 5.1 å•å…ƒæµ‹è¯• (`tests/test_server.py`)

**å·²å®ç°æµ‹è¯•**ï¼š
- âœ… test_health_endpointï¼ˆå¥åº·æ£€æŸ¥ï¼‰
- âœ… test_embed_endpoint_empty_textsï¼ˆè¾¹ç•Œï¼šç©ºåˆ—è¡¨ï¼‰
- âœ… test_embed_endpoint_too_many_textsï¼ˆè¾¹ç•Œï¼š1001 æ¡ï¼‰
- âœ… test_client_health_checkï¼ˆå®¢æˆ·ç«¯å¥åº·æ£€æŸ¥ï¼‰
- âœ… test_client_embed_textsï¼ˆå®¢æˆ·ç«¯ embed åŠŸèƒ½ï¼‰

---

### é˜¶æ®µ 6ï¼šä»£ç è´¨é‡æ”¹è¿› âœ…

#### 6.1 Code Review åé¦ˆå®æ–½

**å·²å®æ–½æ”¹è¿›**ï¼š
- âœ… é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼ˆMAX_QUEUE_SIZE=100ï¼‰
- âœ… è¾“å…¥éªŒè¯ï¼ˆ400/413 é”™è¯¯ç ï¼‰
- âœ… é”™è¯¯åˆ†ç±»ï¼ˆValueError/RuntimeError/Exceptionï¼‰
- âœ… ç±»å‹æ³¨è§£å®Œå–„ï¼ˆæ‰€æœ‰æ¨¡å—ï¼‰
- âœ… ä¼˜é›…å…³é—­ï¼ˆsignal handlerï¼‰
- âœ… è¾¹ç•Œæµ‹è¯•ï¼ˆç©ºåˆ—è¡¨ã€è¿‡å¤š textsï¼‰

**è¯„åˆ†æå‡**ï¼š78% â†’ 87%ï¼ˆ+9%ï¼‰

---

## ğŸ“‹ æœªå®Œæˆå†…å®¹ï¼ˆæ‰‹åŠ¨ä¸ OpenCode äº¤äº’ï¼‰

### é˜¶æ®µ 7ï¼šé›†æˆæµ‹è¯•ä¸éªŒè¯ï¼ˆä¸‹ä¸€æ­¥ï¼‰

#### 7.1 ä¾èµ–å®‰è£…æµ‹è¯•

**ä»»åŠ¡**ï¼šéªŒè¯ server ä¾èµ–æ­£ç¡®å®‰è£…

**éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# å®‰è£… server ä¾èµ–
pip install -e .[server]

# éªŒè¯å®‰è£…
pip list | grep -E "fastapi|uvicorn|httpx"
```

**é¢„æœŸç»“æœ**ï¼š
- fastapi>=0.100.0 âœ…
- uvicorn>=0.23.0 âœ…
- httpx>=0.24.0 âœ…

**OpenCode æç¤ºè¯**ï¼š
```
éªŒè¯ qmd-python-new é¡¹ç›®çš„ server ä¾èµ–å®‰è£…ï¼š
1. å®‰è£…å‘½ä»¤ï¼špip install -e .[server]
2. éªŒè¯å‘½ä»¤ï¼špip list | grep fastapi
3. å¦‚æœå¤±è´¥ï¼Œæ£€æŸ¥ pyproject.toml [project.optional-dependencies.server]
```

---

#### 7.2 Server å¯åŠ¨æµ‹è¯•

**ä»»åŠ¡**ï¼šéªŒè¯ server å¯ä»¥æ­£å¸¸å¯åŠ¨å’Œå“åº”

**éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# å¯åŠ¨ server
qmd server

# å¦ä¸€ä¸ªç»ˆç«¯ï¼šæµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æµ‹è¯• embed ç«¯ç‚¹
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{"texts": ["test query"]}'
```

**é¢„æœŸç»“æœ**ï¼š
- server è¾“å‡ºï¼š`Starting QMD MCP Server...` âœ…
- health è¿”å›ï¼š`{"status": "healthy", "model_loaded": true}` âœ…
- embed è¿”å›ï¼š`{"embeddings": [[0.1, 0.2, ...]]}`ï¼ˆ384 ç»´å‘é‡ï¼‰âœ…

**OpenCode æç¤ºè¯**ï¼š
```
æµ‹è¯• QMD MCP Server å¯åŠ¨å’ŒåŸºæœ¬åŠŸèƒ½ï¼š
1. å¯åŠ¨å‘½ä»¤ï¼šqmd server
2. æµ‹è¯•å¥åº·æ£€æŸ¥ï¼šcurl http://localhost:8000/health
3. æµ‹è¯• embedï¼šcurl -X POST http://localhost:8000/embed -H "Content-Type: application/json" -d '{"texts": ["test"]}'
4. éªŒè¯å“åº”æ ¼å¼å’Œå†…å®¹ï¼ˆ384 ç»´å‘é‡ï¼‰
```

---

#### 7.3 å¤šè¿›ç¨‹å¹¶å‘æµ‹è¯•

**ä»»åŠ¡**ï¼šéªŒè¯å¤šè¿›ç¨‹åœºæ™¯ä¸‹æ˜¾å­˜èŠ‚çœ

**éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# Terminal 1: å¯åŠ¨ server
qmd server

# Terminal 2, 3, 4: å¹¶å‘æœç´¢
qmd search "query1" &
qmd search "query2" &
qmd search "query3" &

# Terminal 5: ç›‘æ§æ˜¾å­˜
nvidia-smi -l 1
```

**é¢„æœŸç»“æœ**ï¼š
- Server æ¨¡å¼æ˜¾å­˜ï¼š2-4GBï¼ˆå•ä¾‹æ¨¡å‹ï¼‰âœ…
- æ‰€æœ‰æœç´¢è¯·æ±‚æ­£å¸¸è¿”å› âœ…
- CPU é˜Ÿåˆ—ä¸²è¡Œå¤„ç†ï¼ˆæ— å¹¶å‘å†²çªï¼‰âœ…

**OpenCode æç¤ºè¯**ï¼š
```
æµ‹è¯• QMD MCP Server å¤šè¿›ç¨‹å¹¶å‘åœºæ™¯ï¼š
1. å¯åŠ¨ serverï¼šqmd server
2. æ‰“å¼€ 3 ä¸ªç»ˆç«¯å¹¶å‘æ‰§è¡Œï¼šqmd search "query1/2/3"
3. ç›‘æ§æ˜¾å­˜ï¼šnvidia-smi
4. éªŒè¯æ˜¾å­˜å ç”¨ 2-4GBï¼ˆvs ç‹¬ç«‹æ¨¡å¼çš„ 6-12GBï¼‰
5. æ£€æŸ¥æ‰€æœ‰æœç´¢ç»“æœæ˜¯å¦æ­£å¸¸è¿”å›
```

---

#### 7.4 æ¨¡å¼åˆ‡æ¢æµ‹è¯•

**ä»»åŠ¡**ï¼šéªŒè¯ auto æ¨¡å¼æ£€æµ‹æ­£ç¡®å·¥ä½œ

**éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# æµ‹è¯• 1ï¼šæ‰‹åŠ¨æŒ‡å®š server æ¨¡å¼
qmd search "test" --mode server

# æµ‹è¯• 2ï¼šæ‰‹åŠ¨æŒ‡å®š standalone æ¨¡å¼
qmd search "test" --mode standalone

# æµ‹è¯• 3ï¼šauto æ¨¡å¼ï¼ˆåº”è¯¥è‡ªåŠ¨æ£€æµ‹ï¼‰
# éœ€è¦ä¿®æ”¹ CLI æ·»åŠ  --mode é€‰é¡¹ï¼Œæˆ–ç›´æ¥åœ¨ä»£ç ä¸­æµ‹è¯•
```

**é¢„æœŸç»“æœ**ï¼š
- Server æ¨¡å¼ï¼šä½¿ç”¨ HTTP å®¢æˆ·ç«¯ âœ…
- Standalone æ¨¡å¼ï¼šæœ¬åœ°æ¨¡å‹åŠ è½½ âœ…
- Auto æ¨¡å¼ï¼šæ ¹æ® VRAM è‡ªåŠ¨é€‰æ‹© âœ…

**OpenCode æç¤ºè¯**ï¼š
```
æµ‹è¯• LLMEngine æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ï¼š
1. ä¿®æ”¹ qmd/cli.py æ·»åŠ  `--mode` é€‰é¡¹åˆ° search å‘½ä»¤
2. æµ‹è¯• server æ¨¡å¼ï¼šqmd search "test" --mode server
3. æµ‹è¯• standalone æ¨¡å¼ï¼šqmd search "test" --mode standalone
4. éªŒè¯ LLMEngine æ­£ç¡®è·¯ç”±åˆ° server æˆ–æœ¬åœ°
5. æµ‹è¯•è‡ªåŠ¨é™çº§ï¼šserver åœæ­¢æ—¶çš„ fallback
```

---

#### 7.5 é™çº§ç­–ç•¥æµ‹è¯•

**ä»»åŠ¡**ï¼šéªŒè¯ server ä¸å¯ç”¨æ—¶çš„è‡ªåŠ¨é™çº§

**éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# Terminal 1: ä¸å¯åŠ¨ server
# Terminal 2: å¼ºåˆ¶ server æ¨¡å¼
qmd search "test" --mode server

# é¢„æœŸï¼šfallback åˆ° standalone æ¨¡å¼
# é¢„æœŸæ—¥å¿—ï¼šWARNING: MCP server unavailable, falling back to standalone
```

**é¢„æœŸç»“æœ**ï¼š
- æ£€æµ‹åˆ° server ä¸å¯ç”¨ âœ…
- è‡ªåŠ¨åˆ‡æ¢åˆ° standalone æ¨¡å¼ âœ…
- æœç´¢ä»ç„¶æ­£å¸¸å·¥ä½œï¼ˆæœ¬åœ°æ¨¡å‹ï¼‰âœ…

**OpenCode æç¤ºè¯**ï¼š
```
æµ‹è¯• MCP Server é™çº§ç­–ç•¥ï¼š
1. ç¡®ä¿æ²¡æœ‰è¿è¡Œçš„ serverï¼ˆnetstat -an | grep 8000ï¼‰
2. å¼ºåˆ¶ server æ¨¡å¼ï¼šqmd search "test" --mode server
3. éªŒè¯è‡ªåŠ¨é™çº§åˆ° standalone æ¨¡å¼
4. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰ "falling back to standalone" è­¦å‘Š
5. éªŒè¯æœç´¢ç»“æœä»ç„¶æ­£å¸¸è¿”å›
```

---

#### 7.6 æ€§èƒ½åŸºå‡†æµ‹è¯•

**ä»»åŠ¡**ï¼šæµ‹é‡å’Œå¯¹æ¯”æ€§èƒ½æŒ‡æ ‡

**éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# æµ‹è¯• 1ï¼šServer æ¨¡å¼å»¶è¿Ÿ
qmd server  # Terminal 1
time qmd search "test query"  # Terminal 2
# é‡å¤ 10 æ¬¡å–å¹³å‡

# æµ‹è¯• 2ï¼šStandalone æ¨¡å¼å»¶è¿Ÿ
time qmd search "test query"  # æ—  server
# é‡å¤ 10 æ¬¡å–å¹³å‡

# æµ‹è¯• 3ï¼šå¹¶å‘ååé‡
for i in {1..10}; do
  qmd search "query $i" &
done
wait
```

**é¢„æœŸç»“æœ**ï¼š
- Server æ¨¡å¼å»¶è¿Ÿï¼š~100msï¼ˆå¯æ¥å—ï¼‰âœ…
- Standalone æ¨¡å¼å»¶è¿Ÿï¼š~50msï¼ˆåŸºå‡†ï¼‰âœ…
- æ˜¾å­˜èŠ‚çœï¼š66%ï¼ˆ2-4GB vs 6-12GBï¼‰âœ…

**OpenCode æç¤ºè¯**ï¼š
```
æ‰§è¡Œ QMD MCP Server æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼š
1. æµ‹è¯• server æ¨¡å¼å»¶è¿Ÿï¼štime qmd search "test"ï¼ˆé‡å¤ 10 æ¬¡ï¼‰
2. æµ‹è¯• standalone æ¨¡å¼å»¶è¿Ÿï¼štime qmd search "test"ï¼ˆæ—  serverï¼Œé‡å¤ 10 æ¬¡ï¼‰
3. è®°å½•å¹³å‡å»¶è¿Ÿå’Œ P95 å€¼
4. ä½¿ç”¨ nvidia-smi ç›‘æ§æ˜¾å­˜å ç”¨
5. å¯¹æ¯”ä¸¤ç§æ¨¡å¼çš„æ˜¾å­˜å’Œå»¶è¿Ÿå·®å¼‚
6. ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šï¼ˆå»¶è¿Ÿã€æ˜¾å­˜ã€ååé‡ï¼‰
```

---

#### 7.7 CLI --mode é€‰é¡¹æ·»åŠ 

**ä»»åŠ¡**ï¼šæ·»åŠ å‘½ä»¤è¡Œé€‰é¡¹ä»¥æ‰‹åŠ¨é€‰æ‹©æ¨¡å¼

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `qmd/cli.py` çš„ `search` å‘½ä»¤

**ä¿®æ”¹å†…å®¹**ï¼š
```python
@search.command()
@click.argument("query")
@click.option("--mode", default="auto", type=click.Choice(['auto', 'standalone', 'server']), help="Embedding mode")
@click.pass_obj
def search(ctx_obj, query, mode):
    """Search documents"""
    # ä¼ é€’ mode ç»™ searcher
    searcher = FTSSearcher(ctx_obj.db)
    results = searcher.search(query, mode=mode)  # éœ€è¦ä¿®æ”¹ searcher æ¥å£
```

**OpenCode æç¤ºè¯**ï¼š
```
ä¸º qmd CLI çš„ search å‘½ä»¤æ·»åŠ  --mode é€‰é¡¹ï¼š
1. ä¿®æ”¹ qmd/cli.py ä¸­çš„ search å‘½ä»¤
2. æ·»åŠ  @click.option("--mode", default="auto", type=click.Choice(['auto', 'standalone', 'server']))
3. ä¿®æ”¹ FTSSearcher æ¥å£æ¥å— mode å‚æ•°
4. ä¼ é€’ mode ç»™ LLMEngine åˆå§‹åŒ–
5. æµ‹è¯•ä¸‰ç§æ¨¡å¼ï¼šauto, standalone, server
```

---

## ğŸ¯ æ€»ä½“è¿›åº¦

**å®Œæˆåº¦**ï¼š**60%**ï¼ˆ6/10 é˜¶æ®µå®Œæˆï¼‰

| é˜¶æ®µ | çŠ¶æ€ | å®Œæˆåº¦ |
|------|------|--------|
| 1. Server æ ¸å¿ƒæ¨¡å— | âœ… | 100% |
| 2. LLMEngine åŒæ¨¡å¼ | âœ… | 100% |
| 3. CLI é›†æˆ | âœ… | 100% |
| 4. é…ç½®ä¸ä¾èµ– | âœ… | 100% |
| 5. å•å…ƒæµ‹è¯• | âœ… | 100% |
| 6. ä»£ç è´¨é‡æ”¹è¿› | âœ… | 100% |
| 7. é›†æˆæµ‹è¯•ä¸éªŒè¯ | â³ | 0% |
| 8. CLI --mode é€‰é¡¹ | â³ | 0% |
| 9. æ–‡æ¡£å®Œå–„ | âœ… | 90% |
| 10. å‘å¸ƒå‡†å¤‡ | â³ | 0% |

---

## ğŸ“ OpenCode äº¤äº’æŒ‡å—

### æ¨èå·¥ä½œæµ

**æ­¥éª¤ 1**ï¼šå¯åŠ¨ OpenCode
```bash
cd D:\moneyProject\qmd-python-new
opencode
```

**æ­¥éª¤ 2**ï¼šå¤åˆ¶ç²˜è´´å¯¹åº”ä»»åŠ¡çš„æç¤ºè¯
- è§ä¸Šè¿° "æœªå®Œæˆå†…å®¹" ä¸­çš„ OpenCode æç¤ºè¯
- æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹å®Œæˆ

**æ­¥éª¤ 3**ï¼šå®¡æŸ¥ä»£ç 
- å®Œæˆåä½¿ç”¨ `review` å‘½ä»¤æ£€æŸ¥
- ç¡®ä¿ä»£ç è´¨é‡ä¿æŒ 85%+

**æ­¥éª¤ 4**ï¼šæµ‹è¯•éªŒè¯
- è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼š`pytest tests/test_server.py`
- æ‰‹åŠ¨æµ‹è¯•ä¸Šè¿°åœºæ™¯

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **æ¶æ„è®¾è®¡**ï¼š`docs/MCP_SERVER.md`
- **æµ‹è¯•æ–‡ä»¶**ï¼š`tests/test_server.py`
- **é¡¹ç›®ä¸»æ–‡æ¡£**ï¼š`README.md`
- **ä»£ç è§„èŒƒ**ï¼š`AGENTS.md`

---

**æœ€åæ›´æ–°**: 2026-02-14 21:21
**ä¸‹æ¬¡æ£€æŸ¥**: 2026-02-15ï¼ˆæµ‹è¯•ä¸éªŒè¯ï¼‰
