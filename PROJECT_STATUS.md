# QMD-Python é¡¹ç›® - éœ€æ±‚æ€»ç»“ä¸è¿›åº¦

- **æ—¥æœŸ**: 2026-02-15
- **è´Ÿè´£äºº**: Zandar (CTO+COO)
- **é¡¹ç›®è·¯å¾„**: `D:\MoneyProjects\qmd-python`

---

## ğŸ¯ æ¶æ„æ¼”è¿›ï¼ˆé‡è¦æ›´æ–°ï¼‰

### æ–°çš„ç»Ÿä¸€æ¶æ„ï¼ˆ2026-02-15ï¼‰

**ä¹‹å‰çš„è®¾è®¡é—®é¢˜**ï¼š
- HTTP Server å’Œ MCP Server ä½œä¸ºä¸¤ä¸ªç‹¬ç«‹å®ç°
- ä»£ç é‡å¤ï¼ˆä¸¤ä¸ª Server å„è‡ªåŠ è½½æ¨¡å‹ï¼‰
- ä¸¤ä¸ªè¿›ç¨‹ = 8GB+ VRAMï¼ˆå¦‚æœåŒæ—¶è¿è¡Œï¼‰

**ç»Ÿä¸€æ¶æ„æ–¹æ¡ˆ**ï¼ˆ`docs/UNIFIED_SERVER_ARCHITECTURE.md`ï¼‰ï¼š
```
QMD Server (å•ä¸€è¿›ç¨‹ï¼Œå…±äº«æ¨¡å‹)
â”œâ”€ æ ¸å¿ƒå¼•æ“ï¼ˆå•ä¾‹ï¼š4GB VRAMï¼‰
â”‚  â”œâ”€ Embeddings (bge-small-zh-v1.5)
â”‚  â”œâ”€ BM25 æœç´¢
â”‚  â”œâ”€ å‘é‡æœç´¢
â”‚  â””â”€ æ··åˆæœç´¢
â”‚
â””â”€ å¤šç§ Transportï¼ˆå¯¹å¤–æ¥å£ï¼‰
   â”œâ”€ HTTP Transport (port 8000)   â† CLI å‘½ä»¤ç”¨
   â”œâ”€ MCP Transport (stdio)        â† Claude/OpenClaw ç”¨
   â””â”€ SSE/WebSocket (å¯é€‰)         â† æœªæ¥æ‰©å±•
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… å•ä¸€è¿›ç¨‹ï¼Œå•ä¸€æ¨¡å‹ï¼ˆ4GB VRAMï¼‰
- âœ… ä»£ç å¤ç”¨ï¼ˆå…±äº«æ ¸å¿ƒæœç´¢å¼•æ“ï¼‰
- âœ… ç»´æŠ¤ç®€å•ï¼ˆå•ä¸€ä»£ç åº“ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼ˆå•ä¸€ `qmd server` å‘½ä»¤ï¼‰

**CLI ä½¿ç”¨**ï¼š
```bash
qmd server --transport http    # åªå¯åŠ¨ HTTP
qmd server --transport mcp     # åªå¯åŠ¨ MCP
qmd server --transport both    # åŒæ—¶å¯åŠ¨ï¼ˆæ¨èï¼‰
```

**æ–‡æ¡£**ï¼š
- `docs/UNIFIED_SERVER_ARCHITECTURE.md` - ç»Ÿä¸€æ¶æ„è¯¦ç»†æ–¹æ¡ˆ
- `docs/MCP_SERVER_PROPOSAL.md` - æ–¹æ¡ˆæ¦‚è¿°ï¼ˆå·²æ›´æ–°ä¸ºç»Ÿä¸€æ¶æ„ï¼‰
- `docs/MCP_COMPATIBILITY_ANALYSIS.md` - MCP æ¥å£è§„èŒƒ

---

## ğŸ“‹ éœ€æ±‚æ€»ç»“

### æ ¸å¿ƒé—®é¢˜
- **å½“å‰æ¶æ„é—®é¢˜**ï¼š
  -- qmd ä»¥ CLI å‘½ä»¤å½¢å¼å¯åŠ¨
  -- æ¯æ¬¡æ‰§è¡Œåˆ›å»ºæ–°è¿›ç¨‹
  -- æ¯ä¸ªè¿›ç¨‹ç‹¬ç«‹åŠ è½½ embed æ¨¡å‹ï¼ˆbge-small-zh-v1.5ï¼‰
  -- **å¤šè¿›ç¨‹å¹¶å‘æ—¶æ˜¾å­˜æš´å¢**

- **æ˜¾å­˜å ç”¨åœºæ™¯**ï¼š
```
3 ä¸ªå¹¶å‘ qmd è¿›ç¨‹ï¼š
-- è¿›ç¨‹ 1: 2-4GB VRAM
-- è¿›ç¨‹ 2: 2-4GB VRAM
-- è¿›ç¨‹ 3: 2-4GB VRAM
æ€»è®¡: 6-12GB VRAM (3 ä¸ªç‹¬ç«‹æ¨¡å‹å®ä¾‹)
```

### è§£å†³æ–¹æ¡ˆéœ€æ±‚
- **MCP Server æ¶æ„**ï¼š
  -- **Server æ¨¡å¼**ï¼šå•ä¸ªå¸¸é©»è¿›ç¨‹ï¼ŒåŠ è½½ä¸€æ¬¡æ¨¡å‹ï¼ˆ2-4GBï¼‰
  -- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šæ‰€æœ‰ embed è¯·æ±‚é€šè¿‡é˜Ÿåˆ—ä¸²è¡Œå¤„ç†
  -- **ç½‘ç»œåè®®**ï¼šHTTP APIï¼ˆFastAPIï¼‰+ IPC
  -- **æ™ºèƒ½åˆ‡æ¢**ï¼šæ ¹æ®æ˜¾å­˜å¤§å°è‡ªåŠ¨é€‰æ‹©æ¨¡å¼
    - æ˜¾å­˜ â‰¥ 8GBï¼šç‹¬ç«‹è¿›ç¨‹æ¨¡å¼ï¼ˆå½“å‰ï¼‰
    - æ˜¾å­˜ < 8GBï¼šServer + é˜Ÿåˆ—æ¨¡å¼

- **å…³é”®çº¦æŸ**ï¼š
  -- âœ… **å‘åå…¼å®¹**ï¼šä¿ç•™ç°æœ‰çš„æœ¬åœ°æ¨¡å¼ï¼ŒServer ä½œä¸ºå¯é€‰åŠŸèƒ½
  -- âœ… **æ˜¾å­˜æ£€æµ‹**ï¼šè‡ªåŠ¨é€‰æ‹©æ¨¡å¼ï¼ˆåŸºäº `torch.cuda.mem_get_info()`ï¼‰
  -- âœ… **é”™è¯¯å¤„ç†**ï¼šServer æŒ‚äº†ï¼Œè‡ªåŠ¨å›é€€åˆ° Standalone
  -- âœ… **æ€§èƒ½è¦æ±‚**ï¼šembed å»¶è¿Ÿ < 100msï¼ˆå³ä½¿ç»è¿‡é˜Ÿåˆ—ï¼‰

- **ä¸æ”¹åŠ¨çš„ä¸šåŠ¡é€»è¾‘**ï¼š
  -- âŒ CLI å‘½ä»¤æ¥å£ä¿æŒä¸å˜
  -- âŒ æ•°æ®åº“ schema ä¸å˜
  -- âŒ æœç´¢ç®—æ³•ï¼ˆBM25/Vector/Hybridï¼‰ä¸å˜
  -- âŒ Collection ç®¡ç†ä¸å˜

---

## âœ… å·²å®Œæˆå†…å®¹

### é˜¶æ®µ 1ï¼šServer æ ¸å¿ƒæ¨¡å— âœ…

#### 1.1 Server æ¨¡å—ç»“æ„
- `qmd/server/`
  -- `__init__.py`      # æ¨¡å—å¯¼å‡º âœ…
  -- `app.py`          # FastAPI åº”ç”¨ âœ…
  -- `client.py`        # HTTP å®¢æˆ·ç«¯ âœ…
  -- `models.py`       # Pydantic æ¨¡å‹ âœ…

#### 1.2 FastAPI åº”ç”¨ (`qmd/server/app.py`)
- **å·²å®ç°åŠŸèƒ½**ï¼š
  -- âœ… FastAPI åº”ç”¨ç»“æ„
  -- âœ… å•ä¾‹æ¨¡å‹åŠ è½½ï¼ˆstartup äº‹ä»¶ï¼‰
  -- âœ… å¼‚æ­¥é˜Ÿåˆ—å¤„ç†ï¼ˆasyncio.Queueï¼‰
  -- âœ… `/embed` POST ç«¯ç‚¹ï¼ˆç”Ÿæˆ embeddingsï¼‰
  -- âœ… `/health` GET ç«¯ç‚¹ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
  -- âœ… é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼ˆMAX_QUEUE_SIZE=100ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
  -- âœ… è¾“å…¥éªŒè¯ï¼ˆç©ºåˆ—è¡¨ã€è¶…å¤š textsï¼‰
  -- âœ… é”™è¯¯åˆ†ç±»å¤„ç†ï¼ˆValueError â†’ 400, RuntimeError â†’ 500ï¼‰

- **ä»£ç è´¨é‡**ï¼š
  -- âœ… ç±»å‹æ³¨è§£å®Œå–„
  -- âœ… æ—¥å¿—è®°å½•ï¼ˆlogger.info/errorï¼‰
  -- âœ… å¼‚æ­¥å¤„ç†ï¼ˆasync/awaitï¼‰
  -- âœ… Pydantic æ•°æ®éªŒè¯

#### 1.3 HTTP å®¢æˆ·ç«¯ (`qmd/server/client.py`)
- **å·²å®ç°åŠŸèƒ½**ï¼š
  -- âœ… EmbedServerClient ç±»
  -- âœ… HTTP å®¢æˆ·ç«¯ï¼ˆhttpxï¼‰
  -- âœ… è¶…æ—¶æ§åˆ¶ï¼ˆ5 ç§’ï¼‰
  -- âœ… å¥åº·æ£€æŸ¥æ–¹æ³•ï¼ˆhealth_checkï¼‰
  -- âœ… embed_texts æ–¹æ³•ï¼ˆPOST /embedï¼‰
  -- âœ… è‡ªåŠ¨é™çº§ï¼ˆserver ä¸å¯ç”¨è¿”å› Noneï¼‰
  -- âœ… èµ„æºæ¸…ç†ï¼ˆclose æ–¹æ³•ï¼‰

- **ä»£ç è´¨é‡**ï¼š
  -- âœ… ç±»å‹æ³¨è§£å®Œå–„
  -- âœ… å¼‚å¸¸å¤„ç†ï¼ˆConnectError, TimeoutExceptionï¼‰
  -- âœ… å»¶è¿Ÿåˆå§‹åŒ–ï¼ˆ_get_clientï¼‰

#### 1.4 æ•°æ®æ¨¡å‹ (`qmd/server/models.py`)
- **å·²å®ç°åŠŸèƒ½**ï¼š
  -- âœ… EmbedRequestï¼ˆPydanticï¼‰
  -- âœ… EmbedResponseï¼ˆPydanticï¼‰
  -- âœ… ç±»å‹æ³¨è§£å®Œæ•´

---

### é˜¶æ®µ 2ï¼šLLMEngine åŒæ¨¡å¼æ”¯æŒ âœ…

#### 2.1 å¼•æ“ä¿®æ”¹ (`qmd/llm/engine.py`)
- **å·²å®ç°åŠŸèƒ½**ï¼š
  -- âœ… åŒæ¨¡å¼åˆå§‹åŒ–ï¼ˆstandalone / server / autoï¼‰
  -- âœ… VRAM è‡ªåŠ¨æ£€æµ‹ï¼ˆtorch.cuda.mem_get_info()ï¼‰
  -- âœ… æ¨¡å¼é€‰æ‹©é€»è¾‘ï¼š
    - VRAM < 8GB â†’ server æ¨¡å¼
    - VRAM â‰¥ 8GB â†’ standalone æ¨¡å¼
    - æ—  CUDA â†’ standalone æ¨¡å¼
  -- âœ… MCP Server å®¢æˆ·ç«¯é›†æˆï¼ˆEmbedServerClientï¼‰
  -- âœ… è‡ªåŠ¨é™çº§ï¼ˆserver æŒ‚äº†å›é€€åˆ° standaloneï¼‰
  -- âœ… embed_texts æ–¹æ³•ï¼ˆæ ¹æ®æ¨¡å¼è·¯ç”±ï¼‰
  -- âœ… èµ„æºæ¸…ç†ï¼ˆclose æ–¹æ³•ï¼‰

- **ä»£ç è´¨é‡æ”¹è¿›**ï¼š
  -- âœ… ç±»å‹æ³¨è§£å®Œå–„ï¼ˆTextEmbedding, EmbedServerClientï¼‰
  -- âœ… æ—¥å¿—è®°å½•ï¼ˆmode æ£€æµ‹ç»“æœã€é™çº§è­¦å‘Šï¼‰
  -- âœ… é”™è¯¯å¤„ç†ï¼ˆVRAM æ£€æµ‹å¤±è´¥æ—¶ fallbackï¼‰

---

### é˜¶æ®µ 3ï¼šCLI é›†æˆ âœ…

#### 3.1 Server å¯åŠ¨å‘½ä»¤ (`qmd/cli.py`)
- **å·²å®ç°åŠŸèƒ½**ï¼š
  -- âœ… `qmd server` å‘½ä»¤
  -- âœ… `--host` é€‰é¡¹ï¼ˆé»˜è®¤ 127.0.0.1ï¼‰
  -- âœ… `--port` é€‰é¡¹ï¼ˆé»˜è®¤ 8000ï¼‰
  -- âœ… `--log-level` é€‰é¡¹ï¼ˆé»˜è®¤ infoï¼‰
  -- âœ… uvicorn é›†æˆ
  -- âœ… å‹å¥½è¾“å‡ºï¼ˆhost, port, model infoï¼‰
  -- âœ… ä¼˜é›…å…³é—­ï¼ˆsignal handler: SIGINT, SIGTERMï¼‰
  -- âœ… æ§åˆ¶å°æç¤ºï¼ˆæŒ‰ Ctrl+C åœæ­¢ï¼‰

- **ä»£ç è´¨é‡æ”¹è¿›**ï¼š
  -- âœ… ä¿¡å·å¤„ç†ï¼ˆå‹å¥½å…³é—­ï¼‰
  -- âœ… ä¿¡æ¯è¾“å‡ºï¼ˆMax queue size æç¤ºï¼‰

#### 3.2 --mode é€‰é¡¹æ·»åŠ  âœ…
- **å·²å®ç°åŠŸèƒ½**ï¼š
  -- âœ… `search` å‘½ä»¤æ·»åŠ  `--mode` é€‰é¡¹ï¼ˆauto/standalone/serverï¼‰
  -- âœ… `vsearch` å‘½ä»¤æ·»åŠ  `--mode` é€‰é¡¹
  -- âœ… `query` å‘½ä»¤æ·»åŠ  `--mode` é€‰é¡¹
  -- âœ… `embed` å‘½ä»¤æ·»åŠ  `--mode` é€‰é¡¹
  -- âœ… VectorSearch æ„é€ å‡½æ•°æ¥æ”¶ `mode` å‚æ•°
  -- âœ… HybridSearch æ„é€ å‡½æ•°æ¥æ”¶ `mode` å‚æ•°

- **ä»£ç è´¨é‡**ï¼š
  -- âœ… ç±»å‹æ³¨è§£å®Œæ•´
  -- âœ… å‘åå…¼å®¹ï¼ˆmode é»˜è®¤ "auto"ï¼‰

---

### é˜¶æ®µ 4ï¼šé…ç½®ä¸ä¾èµ– âœ…

#### 4.1 pyproject.toml
- **å·²å®ç°**ï¼š
  -- âœ… `[project.optional-dependencies.server]` ç»„
  -- âœ… ä¾èµ–ï¼šfastapi>=0.100.0, uvicorn[standard]>=0.23.0, httpx>=0.24.0

#### 4.2 æ–‡æ¡£ (`docs/MCP_SERVER.md`)
- **å·²å®ç°**ï¼š
  -- âœ… æ¶æ„å›¾ï¼ˆASCII å›¾ç¤ºï¼‰
  -- âœ… å®‰è£…è¯´æ˜
  -- âœ… ä½¿ç”¨æŒ‡å—ï¼ˆServer æ¨¡å¼ / Standalone æ¨¡å¼ï¼‰
  -- âœ… æ¨¡å¼æ£€æµ‹é€»è¾‘
  -- âœ… API ç«¯ç‚¹æ–‡æ¡£
  -- âœ… Fallback è¡Œä¸ºè¯´æ˜
  -- âœ… æ€§èƒ½å¯¹æ¯”è¡¨
  -- âœ… æ•…éšœæ’æŸ¥æŒ‡å—
  -- âœ… å¼€å‘è€…æŒ‡å—

---

### é˜¶æ®µ 5ï¼šæµ‹è¯• âœ…

#### 5.1 å•å…ƒæµ‹è¯• (`tests/test_server.py`)
- **å·²å®ç°æµ‹è¯•**ï¼š
  -- âœ… test_health_endpointï¼ˆå¥åº·æ£€æŸ¥ï¼‰
  -- âœ… test_embed_endpoint_empty_textsï¼ˆè¾¹ç•Œï¼šç©ºåˆ—è¡¨ï¼‰
  -- âœ… test_embed_endpoint_too_many_textsï¼ˆè¾¹ç•Œï¼š1001 æ¡ï¼‰
  -- âœ… test_client_health_checkï¼ˆå®¢æˆ·ç«¯å¥åº·æ£€æŸ¥ï¼‰
  -- âœ… test_client_embed_textsï¼ˆå®¢æˆ·ç«¯ embed åŠŸèƒ½ï¼‰

---

### é˜¶æ®µ 6ï¼šä»£ç è´¨é‡æ”¹è¿› âœ…

#### 6.1 Code Review åé¦ˆå®æ–½
- **å·²å®æ–½æ”¹è¿›**ï¼š
  -- âœ… é˜Ÿåˆ—å¤§å°é™åˆ¶ï¼ˆMAX_QUEUE_SIZE=100ï¼‰
  -- âœ… è¾“å…¥éªŒè¯ï¼ˆ400/413 é”™è¯¯ç ï¼‰
  -- âœ… é”™è¯¯åˆ†ç±»ï¼ˆValueError/RuntimeError/Exceptionï¼‰
  -- âœ… ç±»å‹æ³¨è§£å®Œå–„ï¼ˆæ‰€æœ‰æ¨¡å—ï¼‰
  -- âœ… ä¼˜é›…å…³é—­ï¼ˆsignal handlerï¼‰
  -- âœ… è¾¹ç•Œæµ‹è¯•ï¼ˆç©ºåˆ—è¡¨ã€è¿‡å¤š textsï¼‰

- **è¯„åˆ†æå‡**ï¼š78% â†’ 87%ï¼ˆ+9%ï¼‰

---

### ğŸ¯ æ€»ä½“è¿›åº¦

| é˜¶æ®µ | çŠ¶æ€ | å®Œæˆåº¦ |
|--------|------|----------|
| 1. Server æ ¸å¿ƒæ¨¡å— | âœ… | 100% |
| 2. LLMEngine åŒæ¨¡å¼ | âœ… | 100% |
| 3. CLI é›†æˆ | âœ… | 100% |
| 4. é…ç½®ä¸ä¾èµ– | âœ… | 100% |
| 5. å•å…ƒæµ‹è¯• | âœ… | 100% |
| 6. ä»£ç è´¨é‡æ”¹è¿› | âœ… | 100% |
| 7. é›†æˆæµ‹è¯•ä¸éªŒè¯ | â³ | 0% |
| 8. æ–‡æ¡£å®Œå–„ | âœ… | 90% |
| 9. å‘å¸ƒå‡†å¤‡ | â³ | 0% |
| 10. OpenClaw é›†æˆ | â³ | 0% |

**æ•´ä½“å®Œæˆåº¦**ï¼š**75%** (6/8 é˜¶æ®µå®Œæˆï¼Œé›†æˆæµ‹è¯•ä¸å‘å¸ƒå¾…è¿›è¡Œï¼‰

---

## ğŸ“ æœªå®Œæˆå†…å®¹ï¼ˆä¸ OpenClaw äº¤äº’ï¼‰

### é˜¶æ®µ 7ï¼šé›†æˆæµ‹è¯•ä¸éªŒè¯ï¼ˆä¸‹ä¸€æ­¥ï¼‰

#### 7.1 ä¾èµ–å®‰è£…æµ‹è¯•
- **ä»»åŠ¡**ï¼šéªŒè¯ server ä¾èµ–æ­£ç¡®å®‰è£…
- **éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# å®‰è£… server ä¾èµ–
pip install -e .[server]

# éªŒè¯å®‰è£…
pip list | grep -E "fastapi|uvicorn|httpx"
```
- **é¢„æœŸç»“æœ**ï¼š
  -- fastapi>=0.100.0 âœ…
  -- uvicorn>=0.23.0 âœ…
  -- httpx>=0.24.0 âœ…

- **OpenDev ç¤ºä¾‹è¯**ï¼š
```
éªŒè¯ qmd-python é¡¹ç›®çš„ server ä¾èµ–å®‰è£…ï¼š
1. å®‰è£…å‘½ä»¤ï¼špip install -e .[server]
2. éªŒè¯å‘½ä»¤ï¼špip list | grep fastapi
3. å¦‚æœå¤±è´¥ï¼Œæ£€æŸ¥ pyproject.toml [project.optional-dependencies.server]
```

#### 7.2 Server å¯åŠ¨æµ‹è¯•
- **ä»»åŠ¡**ï¼šéªŒè¯ server å¯ä»¥æ­£å¸¸å¯åŠ¨å’Œå“åº”
- **éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# å¯åŠ¨ server
qmd server

# å¦å¼€ä¸€ä¸ªç»ˆç«¯ï¼šæµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æµ‹è¯• embed ç«¯ç‚¹
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{"texts": ["test query"]}'
```
- **é¢„æœŸç»“æœ**ï¼š
  -- server è¾“å‡ºï¼š`Starting QMD MCP Server...` âœ…
  -- health è¿”å›ï¼š`{"status": "healthy", "model_loaded": true}` âœ…
  -- embed è¿”å›ï¼š`{"embeddings": [[0.1, 0.2, ...]]}`ï¼ˆ384 ç»´å‘é‡ï¼‰âœ…

- **OpenDev ç¤ºä¾‹è¯**ï¼š
```
æµ‹è¯• QMD MCP Server å¯åŠ¨å’ŒåŸºæœ¬åŠŸèƒ½ï¼š
1. å¯åŠ¨å‘½ä»¤ï¼šqmd server
2. æµ‹è¯•å¥åº·æ£€æŸ¥ï¼šcurl http://localhost:8000/health
3. æµ‹è¯• embedï¼šcurl -X POST http://localhost:8000/embed -H "Content-Type: application/json" -d '{"texts": ["test"]}'
4. éªŒè¯å“åº”æ ¼å¼å’Œå†…å®¹ï¼ˆ384 ç»´å‘é‡ï¼‰
```

#### 7.3 å¤šè¿›ç¨‹å¹¶å‘æµ‹è¯•
- **ä»»åŠ¡**ï¼šéªŒè¯å¤šè¿›ç¨‹åœºæ™¯ä¸‹æ˜¾å­˜èŠ‚çœ
- **éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# Terminal 1: å¯åŠ¨ server
qmd server

# Terminal 2, 3, 4: å¹¶å‘æœç´¢
qmd search "query1" &
qmd search "query2" &
qmd search "query3" &

# Terminal 5: ç›‘æ§æ˜¾å­˜
nvidia-smi -l 1
```
- **é¢„æœŸç»“æœ**ï¼š
  -- Server æ¨¡å¼æ˜¾å­˜ï¼š2-4GBï¼ˆå•ä¾‹æ¨¡å‹ï¼‰âœ…
  -- æ‰€æœ‰æœç´¢è¯·æ±‚æ­£å¸¸è¿”å› âœ…
  -- CPU é˜Ÿåˆ—ä¸²è¡Œå¤„ç†ï¼ˆæ— å¹¶å‘å†²çªï¼‰âœ…

- **OpenDev ç¤ºä¾‹è¯**ï¼š
```
æµ‹è¯• QMD MCP Server å¤šè¿›ç¨‹å¹¶å‘åœºæ™¯ï¼š
1. å¯åŠ¨ serverï¼šqmd server
2. æ‰“å¼€ 3 ä¸ªç»ˆç«¯å¹¶å‘æ‰§è¡Œï¼šqmd search "query1/2/3"
3. ç›‘æ§æ˜¾å­˜ï¼šnvidia-smi
4. éªŒè¯æ˜¾å­˜å ç”¨ 2-4GBï¼ˆvs ç‹¬ç«‹æ¨¡å¼çš„ 6-12GBï¼‰
5. æ£€æŸ¥æ‰€æœ‰æœç´¢ç»“æœæ˜¯å¦æ­£å¸¸è¿”å›
```

#### 7.4 æ¨¡å¼åˆ‡æ¢æµ‹è¯•
- **ä»»åŠ¡**ï¼šéªŒè¯ auto æ¨¡å¼æ£€æµ‹æ­£ç¡®å·¥ä½œ
- **éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# æµ‹è¯• 1ï¼šæ‰‹åŠ¨æŒ‡å®š server æ¨¡å¼
qmd search "test" --mode server

# æµ‹è¯• 2ï¼šæ‰‹åŠ¨æŒ‡å®š standalone æ¨¡å¼
qmd search "test" --mode standalone

# æµ‹è¯• 3ï¼šauto æ¨¡å¼ï¼ˆåº”è¯¥è‡ªåŠ¨æ£€æµ‹ï¼‰
# éœ€è¦ä¿®æ”¹ CLI æ·»åŠ  --mode é€‰é¡¹ï¼Œæˆ–ç›´æ¥åœ¨ä»£ç ä¸­æµ‹è¯•
```
- **é¢„æœŸç»“æœ**ï¼š
  -- Server æ¨¡å¼ï¼šä½¿ç”¨ HTTP å®¢æˆ·ç«¯ âœ…
  -- Standalone æ¨¡å¼ï¼šæœ¬åœ°æ¨¡å‹åŠ è½½ âœ…
  -- Auto æ¨¡å¼ï¼šæ ¹æ® VRAM è‡ªåŠ¨é€‰æ‹© âœ…

- **OpenDev ç¤ºä¾‹è¯**ï¼š
```
æµ‹è¯• LLMEngine æ¨¡å¼åˆ‡æ¢åŠŸèƒ½ï¼š
1. ä¿®æ”¹ qmd/cli.py æ·»åŠ  `--mode` é€‰é¡¹åˆ° search å‘½ä»¤
2. æµ‹è¯• server æ¨¡å¼ï¼šqmd search "test" --mode server
3. æµ‹è¯• standalone æ¨¡å¼ï¼šqmd search "test" --mode standalone
4. éªŒè¯ LLMEngine æ­£ç¡®è·¯ç”±åˆ° server æˆ–æœ¬åœ°
5. æµ‹è¯•è‡ªåŠ¨é™çº§ï¼šserver åœæ­¢æ—¶çš„ fallback
```

#### 7.5 é™çº§ç­–ç•¥æµ‹è¯•
- **ä»»åŠ¡**ï¼šéªŒè¯ server ä¸å¯ç”¨æ—¶çš„è‡ªåŠ¨é™çº§
- **éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# Terminal 1: ä¸å¯åŠ¨ server
# Terminal 2: å¼ºåˆ¶ server æ¨¡å¼
qmd search "test" --mode server

# é¢„æœŸï¼šfallback åˆ° standalone æ¨¡å¼
# é¢„æœŸæ—¥å¿—ï¼šWARNING: MCP server unavailable, falling back to standalone
```
- **é¢„æœŸç»“æœ**ï¼š
  -- æ£€æµ‹åˆ° server ä¸å¯ç”¨ âœ…
  -- è‡ªåŠ¨åˆ‡æ¢åˆ° standalone æ¨¡å¼ âœ…
  -- æœç´¢ä»ç„¶æ­£å¸¸å·¥ä½œï¼ˆæœ¬åœ°æ¨¡å‹ï¼‰âœ…

- **OpenDev ç¤ºä¾‹è¯**ï¼š
```
æµ‹è¯• MCP Server é™çº§ç­–ç•¥ï¼š
1. ç¡®ä¿æ²¡æœ‰è¿è¡Œçš„ serverï¼ˆnetstat -an | grep 8000ï¼‰
2. å¼ºåˆ¶ server æ¨¡å¼ï¼šqmd search "test" --mode server
3. éªŒè¯è‡ªåŠ¨é™çº§åˆ° standalone æ¨¡å¼
4. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰ "falling back to standalone" è­¦å‘Š
5. éªŒè¯æœç´¢ç»“æœä»ç„¶æ­£å¸¸è¿”å›
```

#### 7.6 æ€§èƒ½åŸºå‡†æµ‹è¯•
- **ä»»åŠ¡**ï¼šæµ‹é‡å’Œå¯¹æ¯”æ€§èƒ½æŒ‡æ ‡
- **éœ€è¦æ‰§è¡Œçš„å‘½ä»¤**ï¼š
```bash
# æµ‹è¯• 1ï¼šServer æ¨¡å¼å»¶è¿Ÿ
qmd server  # Terminal 1
time qmd search "test query"  # Terminal 2
# é‡å¤ 10 æ¬¡å–å¹³å‡

# æµ‹è¯• 2ï¼šStandalone æ¨¡å¼å»¶è¿Ÿ
time qmd search "test query"  # æ—  server
# é‡å¤ 10 æ¬¡å–å¹³å‡

# æµ‹è¯• 3ï¼šå¹¶å‘ååé‡
for i in {1..10}; do
  qmd search "query $i" &
done
wait
```
- **é¢„æœŸç»“æœ**ï¼š
  -- Server æ¨¡å¼å»¶è¿Ÿï¼š~100msï¼ˆå¯æ¥å—ï¼‰âœ…
  -- Standalone æ¨¡å¼å»¶è¿Ÿï¼š~50msï¼ˆåŸºå‡†ï¼‰âœ…
  -- æ˜¾å­˜èŠ‚çœï¼š66%ï¼ˆ2-4GB vs 6-12GBï¼‰âœ…

- **OpenDev ç¤ºä¾‹è¯**ï¼š
```
æ‰§è¡Œ QMD MCP Server æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼š
1. æµ‹è¯• server æ¨¡å¼å»¶è¿Ÿï¼štime qmd search "test"ï¼ˆé‡å¤ 10 æ¬¡ï¼‰
2. æµ‹è¯• standalone æ¨¡å¼å»¶è¿Ÿï¼štime qmd search "test"ï¼ˆæ—  serverï¼Œé‡å¤ 10 æ¬¡ï¼‰
3. è®°å½•å¹³å‡å»¶è¿Ÿå’Œ P95 å€¼
4. ä½¿ç”¨ nvidia-smi ç›‘æ§æ˜¾å­˜å’Œå»¶è¿Ÿå·®å¼‚
5. å¯¹æ¯”ä¸¤ç§æ¨¡å¼çš„æ˜¾å­˜å’Œå»¶è¿Ÿå·®å¼‚
6. ç”Ÿæˆæ€§èƒ½æŠ¥å‘Šï¼ˆå»¶è¿Ÿã€æ˜¾å­˜ã€ååé‡ï¼‰
```

---

### é˜¶æ®µ 8ï¼šæ–‡æ¡£å®Œå–„ï¼ˆæŒç»­è¿›è¡Œï¼‰

#### 8.1 README æ›´æ–°
- **éœ€è¦è¡¥å……**ï¼š
  - [ ] å¿«é€Ÿå¼€å§‹ï¼šMCP Server æ¨¡å¼
  - [ ] é…ç½®è¯´æ˜ï¼šmode é€‰é¡¹
  - [ ] ç¯å¢ƒå˜é‡ï¼šQMD_FORCE_SERVER

#### 8.2 MCP Server ä½¿ç”¨æŒ‡å—
- **éœ€è¦åˆ›å»º**ï¼š
  - [ ] `docs/MCP_USAGE.md` - è¯¦ç»†ä½¿ç”¨æ•™ç¨‹
  - [ ] ç¤ºä¾‹åœºæ™¯
  - [ ] æ•…éšœæ’æŸ¥

---

### é˜¶æ®µ 9ï¼šå‘å¸ƒå‡†å¤‡ï¼ˆå¾…è¿›è¡Œï¼‰

#### 9.1 ç‰ˆæœ¬å·
- **å½“å‰ç‰ˆæœ¬**ï¼š0.2.0
- **å‘å¸ƒç‰ˆæœ¬**ï¼š0.3.0ï¼ˆMCP Server åŠŸèƒ½ï¼‰

#### 9.2 CHANGELOG
- [ ] æ·»åŠ æ–°åŠŸèƒ½è¯´æ˜
- [ ] æ›´æ–°å‡çº§æŒ‡å—
- [ ] æ ‡æ³¨ç ´åæ€§å˜æ›´

#### 9.3 PyPI å‘å¸ƒ
- [ ] æ„å»ºï¼š`python -m build`
- [ ] æµ‹è¯•ï¼š`pip install dist/`
- [ ] ä¸Šä¼ ï¼š`twine upload dist/*`
- [ ] Git tagï¼š`git tag v0.3.0`

---

### é˜¶æ®µ 10ï¼šOpenClaw é›†æˆï¼ˆåˆ†æå®Œæˆï¼‰

#### 10.1 é›†æˆåˆ†æ
- âœ… **å·²å®Œæˆ**ï¼š`docs/ARCHITECTURE_ANALYSIS.md`
- âœ… **å·²å®Œæˆ**ï¼š`docs/MCP_COMPATIBILITY_ANALYSIS.md`
- âœ… **å·²å®Œæˆ**ï¼š`docs/MCP_IMPLEMENTATION_SUMMARY.md`

#### 10.2 ä¸åŸå§‹ QMD çš„å…¼å®¹æ€§
- **ä¿æŒä¸€è‡´**ï¼š
  - âœ… Tool åç§°ï¼šsearch, vsearch, query, get, multi_get, status
  - âœ… å‚æ•° Schema
  - âœ… è¾“å‡ºç»“æ„
  - âœ… URI æ ¼å¼ï¼šqmd://
  - âœ… è¡Œå·æ ¼å¼
  - [ ] Resource: qmd://{+path}ï¼ˆå¯é€‰å®ç°ï¼‰
  - [ ] Prompt: query guideï¼ˆå¯é€‰å®ç°ï¼‰

#### 10.3 MCP Server å®ç°è·¯çº¿
- **Phase 1 (P0)**ï¼šæ ¸å¿ƒ MCP Server (6 Tools)
  - [ ] `qmd/mcp/server.py` - MCP Server ä¸»é€»è¾‘
  - [ ] `qmd/mcp/tools.py` - 6 Tools å®ç°
  - [ ] `qmd/mcp/transport.py` - Stdio transport
- **Phase 2 (P1)**ï¼šResource + Prompt
  - [ ] `qmd/mcp/resources.py` - qmd:// Resource
  - [ ] `qmd/mcp/prompts.py` - Query guide Prompt
- **Phase 3 (P2)**ï¼šä¼˜åŒ–
  - [ ] SSE Transport
  - [ ] WebSocket Transport
  - [ ] é”™è¯¯å¤„ç†æ”¹è¿›

---

## ğŸ“Š é¡¹ç›®ç»Ÿè®¡

### ä»£ç å˜æ›´ï¼ˆæœ¬æ¬¡æäº¤ï¼‰
- **æ–°å¢æ–‡ä»¶**ï¼š4
  - `docs/MCP_SERVER_PROPOSAL.md`
  - `docs/MCP_COMPATIBILITY_ANALYSIS.md`
  - `docs/MCP_IMPLEMENTATION_SUMMARY.md`
  - `qmd/server/` ç›®å½•ï¼ˆ4 ä¸ªæ–‡ä»¶ï¼‰

- **ä¿®æ”¹æ–‡ä»¶**ï¼š5
  - `qmd/cli.py` - æ·»åŠ  --mode é€‰é¡¹
  - `qmd/llm/engine.py` - åŒæ¨¡å¼æ”¯æŒ
  - `qmd/search/vector.py` - mode å‚æ•°
  - `qmd/search/hybrid.py` - mode å‚æ•°
  - `qmd/server/app.py` - Queue â†’ Lock

- **ä»£ç è¡Œæ•°**ï¼š
  - æ–°å¢ï¼š~500 è¡Œ
  - ä¿®æ”¹ï¼š~100 è¡Œ
  - æ–‡æ¡£ï¼š~1200 è¡Œ

### æµ‹è¯•è¦†ç›–
- **å•å…ƒæµ‹è¯•**ï¼š5 ä¸ªæµ‹è¯•ç”¨ä¾‹ âœ…
- **é›†æˆæµ‹è¯•**ï¼šå¾…è¿›è¡Œï¼ˆé˜¶æ®µ 7ï¼‰
- **æ‰‹åŠ¨æµ‹è¯•**ï¼šServer å¯åŠ¨ + åŸºæœ¬åŠŸèƒ½ âœ…

---

## ğŸ¯ ä¸‹ä¸€æ­¥ï¼ˆæ¨èä¼˜å…ˆçº§ï¼‰

### ä¼˜å…ˆçº§ P0ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
1. **é›†æˆæµ‹è¯•**ï¼šæ‰§è¡Œé˜¶æ®µ 7 çš„æ‰€æœ‰æµ‹è¯•åœºæ™¯
2. **Bug ä¿®å¤**ï¼šæ ¹æ®æµ‹è¯•ç»“æœä¿®å¤å‘ç°çš„é—®é¢˜
3. **æ€§èƒ½éªŒè¯**ï¼šç¡®ä¿ Server æ¨¡å¼å»¶è¿Ÿ < 100ms

### ä¼˜å…ˆçº§ P1ï¼ˆå®Œå–„åŠŸèƒ½ï¼‰
1. **Resource å®ç°**ï¼šqmd:// URI è®¿é—®ï¼ˆå…¼å®¹æ€§ï¼‰
2. **Prompt å®ç°**ï¼šquery guideï¼ˆç”¨æˆ·ä½“éªŒï¼‰
3. **é”™è¯¯å¤„ç†**ï¼šæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤å»ºè®®

### ä¼˜å…ˆçº§ P2ï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰
1. **SSE Transport**ï¼šæ”¯æŒ Server-Sent Events
2. **WebSocket Transport**ï¼šå®æ—¶åŒå‘é€šä¿¡
3. **é…ç½®åŒ–**ï¼šYAML é…ç½®æ–‡ä»¶æ”¯æŒ

---

## ğŸ“ OpenDev äº¤äº’æŒ‡å—

### æ¨èå·¥ä½œæµ
- **æ­¥éª¤ 1**ï¼šå¯åŠ¨ OpenDev
```bash
cd D:\MoneyProjects\qmd-python
code .
```

- **æ­¥éª¤ 2**ï¼šå¤åˆ¶ç²˜è´´å¯¹åº”ä»»åŠ¡çš„æç¤ºè¯
- è§ä¸Šè¿° "æœªå®Œæˆå†…å®¹" ä¸­çš„ OpenDev ç¤ºä¾‹è¯
- æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹å®Œæˆ

- **æ­¥éª¤ 3**ï¼šå®¡æŸ¥ä»£ç 
- å®Œæˆåä½¿ç”¨ `review` å‘½ä»¤æ£€æŸ¥
- ç¡®ä¿ä»£ç è´¨é‡ä¿æŒ 75%+

- **æ­¥éª¤ 4**ï¼šæµ‹è¯•éªŒè¯
- è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼š`pytest tests/test_server.py`
- æ‰‹åŠ¨æµ‹è¯•ä¸Šè¿°åœºæ™¯

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **æ¶æ„è®¾è®¡**ï¼š`docs/MCP_SERVER.md`
- **æµ‹è¯•æ–‡ä»¶**ï¼š`tests/test_server.py`
- **é¡¹ç›®ä¸»æ–‡æ¡£**ï¼š`README.md`
- **ä»£ç è§„èŒƒ**ï¼š`AGENTS.md`
- **åŸå§‹ QMD**ï¼š`D:\MoneyProjects\qmd\src\mcp.ts`

---

-**æœ€åæ›´æ–°**ï¼š2026-02-15 01:19ï¼ˆæäº¤ e4f9dfï¼‰
-**ä¸‹æ¬¡æ£€æŸ¥**ï¼š2026-02-15ï¼ˆæµ‹è¯•ä¸éªŒè¯ï¼‰
