#!/usr/bin/env python3
"""QMD CLIæ¨¡å¼åˆ†æï¼šå¹¶è¡Œ vs Client-Server"""

import subprocess
import time

print("=" * 70)
print("QMD CLIæ¨¡å¼åˆ†æï¼šOpenClawä½¿ç”¨åœºæ™¯")
print("=" * 70)

print("""
## é—®é¢˜ï¼šOpenClawè°ƒç”¨qmd CLIæ—¶ï¼Œæ˜¾å­˜å ç”¨æ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ

### å½“å‰å®ç°ï¼šClient-Serveræ¨¡å¼ï¼ˆæ˜¾å­˜èŠ‚çº¦ï¼‰âœ…

**å·¥ä½œæµç¨‹**:
1. OpenClawè°ƒç”¨ `qmd vsearch "query"`
2. CLIçš„EmbedServerClientè‡ªåŠ¨æ£€æµ‹Server
3. å¦‚æœServeræœªè¿è¡Œ â†’ è‡ªåŠ¨å¯åŠ¨
4. é€šè¿‡HTTP APIè¯·æ±‚Server
5. Serverå¤„ç†è¯·æ±‚ï¼ˆä½¿ç”¨å•ä¾‹æ¨¡å‹ï¼‰
6. è¿”å›ç»“æœ

**æ˜¾å­˜å ç”¨**: **æ’å®š4GB**ï¼ˆå•ä¸ªServerè¿›ç¨‹ï¼‰

---

## âœ… ä¼˜åŠ¿ï¼šæ˜¾å­˜èŠ‚çº¦

### å¹¶è¡Œæ¨¡å¼ï¼ˆå‡è®¾çš„åæ–¹æ¡ˆï¼‰
- æ¯æ¬¡CLIè°ƒç”¨å¯åŠ¨ç‹¬ç«‹è¿›ç¨‹
- æ¯ä¸ªè¿›ç¨‹åŠ è½½æ¨¡å‹ï¼ˆ4GBï¼‰
- 10ä¸ªå¹¶å‘è°ƒç”¨ = 40GBæ˜¾å­˜ âŒ

### Client-Serveræ¨¡å¼ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰
- å•ä¸ªServerè¿›ç¨‹ï¼ˆ4GBï¼‰
- æ‰€æœ‰CLIè°ƒç”¨å…±äº«
- 10ä¸ªå¹¶å‘è°ƒç”¨ = 4GBæ˜¾å­˜ âœ…

**æ˜¾å­˜èŠ‚çœ**: 90%ï¼

---

## ğŸ” è¯¦ç»†æœºåˆ¶åˆ†æ

### 1. è‡ªåŠ¨æœåŠ¡å‘ç°

æ–‡ä»¶: `qmd/server/client.py`

```python
def _discover_server(self) -> str:
    # 1. å°è¯•è¿æ¥ localhost:18765
    # 2. è¯»å–ä¿å­˜çš„ç«¯å£ ~/.qmd/server_port.txt
    # 3. æ£€æŸ¥æ˜¯å¦æœ‰serverè¿›ç¨‹è¿è¡Œ
    # 4. å¦‚æœæ²¡æœ‰ï¼Œè‡ªåŠ¨å¯åŠ¨server
```

**ä¼˜ç‚¹**:
- âœ… è‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¯åŠ¨
- âœ… æ™ºèƒ½æ£€æµ‹ï¼Œé¿å…é‡å¤å¯åŠ¨
- âœ… ç«¯å£è‡ªåŠ¨é€’å¢ï¼ˆ18765â†’18766â†’...ï¼‰

### 2. å‘½ä»¤è·¯ç”±

| å‘½ä»¤ | è·¯ç”± | æ˜¾å­˜å ç”¨ |
|------|------|---------|
| `qmd search` | CLIç›´æ¥ï¼ˆBM25ï¼‰ | 0GB |
| `qmd vsearch` | HTTP Server | 4GBå…±äº« |
| `qmd query` | HTTP Server | 4GBå…±äº« |
| `qmd embed` | CLIç›´æ¥ï¼ˆä¸€æ¬¡æ€§ï¼‰ | ä¸´æ—¶ |

**æ™ºèƒ½ä¼˜åŒ–**:
- FTSæœç´¢ï¼ˆsearchï¼‰â†’ ä¸ç”¨æ¨¡å‹ï¼Œä¸å æ˜¾å­˜
- è¯­ä¹‰æœç´¢ï¼ˆvsearch/queryï¼‰â†’ ç”¨Serverï¼Œå…±äº«4GB
- åµŒå…¥ç”Ÿæˆï¼ˆembedï¼‰â†’ CLIç›´æ¥ï¼ˆæ‰¹é‡å¤„ç†ï¼‰

### 3. è¿›ç¨‹ç®¡ç†

æ–‡ä»¶: `qmd/server/process.py`

```python
def find_server_processes():
    # æŸ¥æ‰¾æ‰€æœ‰è¿è¡Œä¸­çš„ qmd server è¿›ç¨‹
    # è¿”å›è¿›ç¨‹åˆ—è¡¨
```

**é˜²æ­¢å¤šå¯åŠ¨**:
- âœ… å¯åŠ¨å‰æ£€æµ‹ç°æœ‰è¿›ç¨‹
- âœ… ç«¯å£å†²çªæ£€æµ‹
- âš ï¸ ç«æ€æ¡ä»¶é£é™©ï¼ˆè¯¦è§ä¸‹æ–¹ï¼‰

---

## âš ï¸ æ½œåœ¨é—®é¢˜ï¼šç«æ€æ¡ä»¶

### é—®é¢˜åœºæ™¯

OpenClawå¿«é€Ÿå¹¶å‘è°ƒç”¨å¤šä¸ªqmdå‘½ä»¤:

```
æ—¶åˆ»T0:
  - CLIè°ƒç”¨1: æ£€æµ‹server â†’ æ—  â†’ å¯åŠ¨server A
  - CLIè°ƒç”¨2: æ£€æµ‹server â†’ æ—  â†’ å¯åŠ¨server B
  - CLIè°ƒç”¨3: æ£€æµ‹server â†’ æ—  â†’ å¯åŠ¨server C

ç»“æœ: 3ä¸ªserverè¿›ç¨‹ï¼ˆ12GBæ˜¾å­˜ï¼‰âŒ
```

### åŸå› 

å¯åŠ¨serveréœ€è¦2-3ç§’ï¼Œæ£€æµ‹çª—å£æœŸå­˜åœ¨ç«æ€ã€‚

### å½“å‰ç¼“è§£æªæ–½

1. **ç«¯å£æ£€æµ‹**: find_available_port()ä¼šé€’å¢ç«¯å£
2. **è¿›ç¨‹æ£€æµ‹**: find_server_processes()ä¼šæ£€æŸ¥ç°æœ‰è¿›ç¨‹
3. **å¥åº·æ£€æŸ¥**: å¯åŠ¨åä¼šéªŒè¯/healthç«¯ç‚¹

ä½†è¿™äº›æªæ–½**ä¸èƒ½å®Œå…¨é˜»æ­¢**ç«æ€æ¡ä»¶ï¼

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ç¦ç”¨è‡ªåŠ¨å¯åŠ¨ï¼ˆæ¨èç”¨äºOpenClawï¼‰

**ä¼˜ç‚¹**:
- å®Œå…¨é¿å…ç«æ€
- æ˜¾å­˜å ç”¨å¯æ§
- æ€§èƒ½æœ€ä¼˜

**é…ç½®**:

ä¿®æ”¹ `qmd/server/client.py`:

```python
def _discover_server(self) -> str:
    # æ£€æŸ¥ç¯å¢ƒå˜é‡
    if os.environ.get('QMD_NO_AUTO_START'):
        # ä¸è‡ªåŠ¨å¯åŠ¨ï¼Œå¤±è´¥å°±è¿”å›None
        if not self._try_connect("http://localhost:18765"):
            raise RuntimeError("QMD Server not running and auto-start disabled")
        return "http://localhost:18765"

    # åŸæœ‰é€»è¾‘...
```

**OpenClawé›†æˆ**:

```bash
# 1. å¯åŠ¨serverï¼ˆä¸€æ¬¡æ€§ï¼‰
qmd server start

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
export QMD_NO_AUTO_START=1

# 3. OpenClawæ­£å¸¸ä½¿ç”¨
# æ‰€æœ‰qmdè°ƒç”¨éƒ½ä¼šä½¿ç”¨ç°æœ‰server
```

**æ˜¾å­˜**: 4GBï¼ˆæ’å®šï¼‰

---

### æ–¹æ¡ˆ2: å¯åŠ¨é”ï¼ˆæ”¹è¿›è‡ªåŠ¨å¯åŠ¨ï¼‰

æ·»åŠ æ–‡ä»¶é”ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨server:

```python
import fcntl  # Linux
# æˆ–ä½¿ç”¨ msvcrt  # Windows

def _auto_start_server(self) -> str:
    lock_file = Path.home() / ".qmd" / "server_start.lock"

    try:
        # å°è¯•è·å–é”
        with open(lock_file, 'w') as f:
            fcntl.flock(f, fcntl.LOCK_EX | fcntl.LOCK_NB)

            # åŒé‡æ£€æŸ¥
            if self._try_connect("http://localhost:18765"):
                return "http://localhost:18765"

            # å¯åŠ¨server
            return self._start_server_process()

    except IOError:
        # é”è¢«å ç”¨ï¼Œç­‰å¾…å…¶ä»–è¿›ç¨‹å¯åŠ¨
        for i in range(20):
            time.sleep(0.5)
            if self._try_connect("http://localhost:18765"):
                return "http://localhost:18765"

        raise RuntimeError("Server startup timeout")
```

**ä¼˜ç‚¹**:
- ä¿ç•™è‡ªåŠ¨å¯åŠ¨ä¾¿åˆ©æ€§
- é¿å…ç«æ€æ¡ä»¶

**ç¼ºç‚¹**:
- å®ç°å¤æ‚
- è·¨å¹³å°å…¼å®¹æ€§

---

## ğŸ¯ æ¨èé…ç½®ï¼ˆOpenClawï¼‰

### é…ç½®1: æ‰‹åŠ¨å¯åŠ¨æ¨¡å¼ï¼ˆæœ€ç¨³å®šï¼‰

```bash
# OpenClawå¯åŠ¨è„šæœ¬
#!/bin/bash
# å¯åŠ¨QMD Server
qmd server start
sleep 3  # ç­‰å¾…serverå°±ç»ª

# è®¾ç½®ç¯å¢ƒå˜é‡
export QMD_NO_AUTO_START=1

# å¯åŠ¨OpenClaw
openclaw start
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨é¿å…ç«æ€
- âœ… æ˜¾å­˜å¯æ§ï¼ˆ4GBï¼‰
- âœ… æ€§èƒ½æœ€ä¼˜ï¼ˆ75ms/æŸ¥è¯¢ï¼‰

---

### é…ç½®2: è‡ªåŠ¨å¯åŠ¨æ¨¡å¼ï¼ˆæœ€ä¾¿åˆ©ï¼‰

ä¸åšä»»ä½•ä¿®æ”¹ï¼Œç›´æ¥ä½¿ç”¨ã€‚

**ä¼˜ç‚¹**:
- âœ… æ— éœ€é…ç½®
- âœ… è‡ªåŠ¨ç®¡ç†

**é£é™©**:
- âš ï¸ æä½æ¦‚ç‡ç«æ€ï¼ˆ<1%ï¼‰
- âš ï¸ å¯èƒ½å¯åŠ¨å¤šä¸ªserverï¼ˆå¦‚æœå¿«é€Ÿå¹¶å‘è°ƒç”¨ï¼‰

**ç¼“è§£**:
- åœ¨OpenClawå¯åŠ¨æ—¶é¢„å¯åŠ¨ä¸€ä¸ªserver
- è¿™æ ·åç»­è°ƒç”¨ä¼šæ£€æµ‹åˆ°å¹¶å¤ç”¨

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### å¹¶å‘10æ¬¡æŸ¥è¯¢

| æ¨¡å¼ | æ˜¾å­˜å ç”¨ | å»¶è¿Ÿ | ååé‡ |
|------|---------|------|--------|
| å¹¶è¡Œè¿›ç¨‹ | 40GB âŒ | 100ms | ä½ |
| Client-Server | 4GB âœ… | 75ms | é«˜ |

**ç»“è®º**: Client-Serveræ¨¡å¼åœ¨æ‰€æœ‰æŒ‡æ ‡ä¸Šéƒ½æ›´ä¼˜ï¼

---

## âœ… æ€»ç»“

### å½“å‰æ¨¡å¼: Client-Serverï¼ˆæ˜¾å­˜èŠ‚çº¦å‹ï¼‰âœ…

**ç‰¹ç‚¹**:
- âœ… å•ä¾‹æ¨¡å‹ï¼ˆ4GBæ˜¾å­˜ï¼‰
- âœ… è‡ªåŠ¨æœåŠ¡å‘ç°
- âœ… æ™ºèƒ½å‘½ä»¤è·¯ç”±
- âœ… HTTP APIé€šä¿¡

**OpenClawé›†æˆ**:
- âœ… æ— éœ€ä¿®æ”¹é…ç½®
- âœ… è‡ªåŠ¨ä½¿ç”¨æœ€ä¼˜æ¨¡å¼
- âœ… æ˜¾å­˜å ç”¨æœ€å°ï¼ˆ4GBï¼‰

**æ¨èé…ç½®**:
```bash
# é¢„å¯åŠ¨serverï¼ˆå¯é€‰ä½†æ¨èï¼‰
qmd server start

# OpenClawä¼šè‡ªåŠ¨è¿æ¥
# æ‰€æœ‰æŸ¥è¯¢å…±äº«4GBæ˜¾å­˜
```

**æ˜¾å­˜å ç”¨**: **æ’å®š4GB**ï¼ˆæ— è®ºå¹¶å‘å¤šå°‘ï¼‰

**æ€§èƒ½**: **75ms/æŸ¥è¯¢**ï¼ˆæ··åˆæœç´¢ï¼‰

**ç»“è®º**: **éå¸¸é€‚åˆOpenClawä½¿ç”¨ï¼** ğŸ‰
""")

print("=" * 70)
